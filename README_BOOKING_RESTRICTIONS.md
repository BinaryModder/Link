# Ограничения бронирования: только квартиры

## Проблема
В личном кабинете пользователя можно было забронировать как ЖК, так и квартиру. По логике бизнеса пользователи должны бронировать только квартиры, а не жилые комплексы.

## Решение

### Backend изменения

#### 1. CRUD операции (Property_crud.py)
Добавлены проверки в следующие функции:
- `create_booking()` - проверка, что объект имеет `complex_id` (является квартирой)
- `create_purchase()` - проверка, что объект имеет `complex_id` (является квартирой)
- `create_mortgage()` - проверка, что объект имеет `complex_id` (является квартирой)
- `purchase_property()` - проверка, что объект имеет `complex_id` (является квартирой)

#### 2. Поиск недвижимости (Property_crud.py)
**Обновлена функция `search_properties()`:**
- **По умолчанию** показываются только квартиры (объекты с `complex_id`)
- `complex_id='any'` - поиск только квартир (объекты с `complex_id`)
- `complex_id=123` - поиск квартир в конкретном ЖК

**Обновлена функция `get_properties()`:**
- **По умолчанию** показываются только квартиры (объекты с `complex_id`)
- Если `complex_id` не указан, показываются все квартиры
- Если `complex_id` указан, показываются квартиры из конкретного ЖК

#### 3. Схемы данных (Property_schema.py)
Обновлена схема `PropertySearch`:
- Добавлено поле `complex_id: Optional[str]` для фильтрации

#### 4. API роуты (Property_router.py)
Обновлен эндпоинт `/properties/search`:
- Добавлен параметр `complex_id` для фильтрации по ЖК

### Frontend изменения

#### 1. Личный кабинет пользователя (UserDashboard.vue)
- Обновлены заголовки: "Забронированные квартиры", "Купленные квартиры"
- Обновлена форма поиска: "Поиск квартир"
- Обновлены сообщения: "Квартира забронирована!", "Квартира успешно куплена!"
- **Упрощен поиск** - убран параметр `complex_id: 'any'`, так как по умолчанию показываются только квартиры

#### 2. Поиск ЖК (ComplexSearch.vue)
- Обновлены сообщения об ошибках: "Ошибка при бронировании квартиры"
- Кнопка "Забронировать" доступна только для квартир в модальном окне

#### 3. API утилиты (api.js)
- Обновлена функция `searchProperties()` для поддержки параметра `complex_id`

## Логика работы

### Определение типа объекта
- **Квартира**: объект в таблице `Properties` с `complex_id != NULL`
- **ЖК**: объект в таблице `Properties` с `complex_id = NULL` или объект в таблице `ResidentialComplex`

### Ограничения
1. **Бронирование**: только квартиры
2. **Покупка**: только квартиры  
3. **Ипотека**: только квартиры
4. **Поиск в ЛК**: только квартиры
5. **Поиск по умолчанию**: только квартиры

### Сообщения об ошибках
При попытке забронировать/купить ЖК пользователь получит сообщение:
- "Можно бронировать только квартиры, а не жилые комплексы"
- "Можно покупать только квартиры, а не жилые комплексы"
- "Можно оформить ипотеку только на квартиры, а не на жилые комплексы"

## Тестирование

Созданы тестовые файлы:

### 1. test_booking_restrictions.py
Проверяет ограничения бронирования:
1. Успешное бронирование квартиры
2. Отказ в бронировании ЖК

### 2. test_search_only_apartments.py
Проверяет, что поиск по умолчанию показывает только квартиры:
1. Поиск без параметров показывает только квартиры
2. Поиск с `complex_id='any'` показывает только квартиры
3. Поиск с конкретным `complex_id` показывает квартиры из этого ЖК
4. `get_properties()` без параметров показывает только квартиры

Запуск тестов:
```bash
cd backend
python test_booking_restrictions.py
python test_search_only_apartments.py
```

## Результат

Теперь в личном кабинете пользователя:
- ✅ Можно бронировать только квартиры
- ✅ Можно покупать только квартиры
- ✅ Можно оформлять ипотеку только на квартиры
- ✅ Поиск показывает только квартиры
- ✅ Поиск по умолчанию показывает только квартиры
- ❌ Нельзя бронировать/покупать ЖК
- ❌ ЖК не отображаются в результатах поиска

Система стала более логичной и соответствует бизнес-требованиям. Пользователи больше не смогут случайно забронировать жилой комплекс вместо квартиры, и ЖК вообще не будут отображаться в результатах поиска. 