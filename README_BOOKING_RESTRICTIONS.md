# Ограничения бронирования: только квартиры

## Проблема
В личном кабинете пользователя можно было забронировать как ЖК, так и квартиру. По логике бизнеса пользователи должны бронировать только квартиры, а не жилые комплексы.

## Решение

### Backend изменения

#### 1. CRUD операции (Property_crud.py)
Добавлены проверки в следующие функции:
- `create_booking()` - проверка, что объект имеет `complex_id` (является квартирой)
- `create_purchase()` - проверка, что объект имеет `complex_id` (является квартирой)
- `create_mortgage()` - проверка, что объект имеет `complex_id` (является квартирой)
- `purchase_property()` - проверка, что объект имеет `complex_id` (является квартирой)

#### 2. Поиск недвижимости (Property_crud.py)
Обновлена функция `search_properties()` для поддержки фильтра `complex_id`:
- `complex_id='any'` - поиск только квартир (объектов с `complex_id`)
- `complex_id=123` - поиск квартир в конкретном ЖК

#### 3. Схемы данных (Property_schema.py)
Обновлена схема `PropertySearch`:
- Добавлено поле `complex_id: Optional[str]` для фильтрации

#### 4. API роуты (Property_router.py)
Обновлен эндпоинт `/properties/search`:
- Добавлен параметр `complex_id` для фильтрации по ЖК

### Frontend изменения

#### 1. Личный кабинет пользователя (UserDashboard.vue)
- Обновлены заголовки: "Забронированные квартиры", "Купленные квартиры"
- Обновлена форма поиска: "Поиск квартир"
- Обновлены сообщения: "Квартира забронирована!", "Квартира успешно куплена!"
- Добавлен фильтр `complex_id: 'any'` в поиск для показа только квартир

#### 2. Поиск ЖК (ComplexSearch.vue)
- Обновлены сообщения об ошибках: "Ошибка при бронировании квартиры"
- Кнопка "Забронировать" доступна только для квартир в модальном окне

#### 3. API утилиты (api.js)
- Обновлена функция `searchProperties()` для поддержки параметра `complex_id`

## Логика работы

### Определение типа объекта
- **Квартира**: объект в таблице `Properties` с `complex_id != NULL`
- **ЖК**: объект в таблице `Properties` с `complex_id = NULL` или объект в таблице `ResidentialComplex`

### Ограничения
1. **Бронирование**: только квартиры
2. **Покупка**: только квартиры  
3. **Ипотека**: только квартиры
4. **Поиск в ЛК**: только квартиры

### Сообщения об ошибках
При попытке забронировать/купить ЖК пользователь получит сообщение:
- "Можно бронировать только квартиры, а не жилые комплексы"
- "Можно покупать только квартиры, а не жилые комплексы"
- "Можно оформить ипотеку только на квартиры, а не на жилые комплексы"

## Тестирование

Создан тестовый файл `test_booking_restrictions.py` для проверки:
1. Успешное бронирование квартиры
2. Отказ в бронировании ЖК

Запуск теста:
```bash
cd backend
python test_booking_restrictions.py
```

## Результат

Теперь в личном кабинете пользователя:
- ✅ Можно бронировать только квартиры
- ✅ Можно покупать только квартиры
- ✅ Можно оформлять ипотеку только на квартиры
- ✅ Поиск показывает только квартиры
- ❌ Нельзя бронировать/покупать ЖК

Система стала более логичной и соответствует бизнес-требованиям. 